#!/usr/bin/env python
"""Move DOF.

Usage:
  moveDof backup <address> [--output-file=<of> | -o <of>]
  moveDof restore <address> (--input-file=<if> | -i <if>)
  moveDof move <from-address> <to-address> [--output-file=<of> | -o <of>]
  moveDof (-h | --help)

Options:
  -h --help                   Show this screen.
  -o <of> --output-file=<of>  Store the parameters in a file, default is stdout.
  -i <if> --input-file=<if>   Load the parameters from a file into a DOF.
"""
import re

from docopt import docopt
from subprocess import check_output as run

critical_parameters = [ ("P Gain", "P")
                      , ("I Gain", "I")
                      , ("D Gain", "D")
                      , ("Dead Zone", "Z")
                      , ("Lower Limit", "L")
                      , ("Upper Limit", "U")
                      , ("Limit Flags", "K")
                      , ("Accumulator Limit", "A")
                      , ("Encoder Frequency", "F")
                      , ("Max PWM DC", "W")
                      , ("Mode", "M")
                      , ("QEI Config", "E")
                      ]


def doBackup(addr, filename):
  for name, cmd in critical_parameters:
    print "Querying {0} on {1}.".format(name, addr)
    raw_output = run(["XiControl", "-n", addr, "-c", '? {0}'.format(cmd)])
    result = re.search("^\*[^:]+:(.+)$",  raw_output, flags=re.MULTILINE)
    if result:
      print "{0}: {1}".format(name, result.group(1))


def doRestore(addr, filename):
  pass


def doMove(src, dest, filename):
  pass


if __name__ == '__main__':
    arguments = docopt(__doc__, version='Move DOF 0.1')
    if arguments["backup"]:
      doBackup(arguments["<address>"], arguments["--output-file"])
    elif arguments["restore"]:
      doRestore(arguments["<address>"], arguments["--input-file"])
    elif arguments["move"]:
      doMove(arguments["<from-address>"], arguments["<to-address>"], arguments["--output-file"])
